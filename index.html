<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Electron TCP</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <h1>Electron TCP</h1>
        <div class="sidebar">
            <fieldset>
                <legend>Server Mode</legend>
                <input type="text" name="server_port" id="server_port" value="5001" placeholder="Port">
                <br>
                <button type="button" id="btn_server_start">Listen</button>
            </fieldset>
            <fieldset>
                <legend>Client Mode</legend>
                <input type="text" name="ip" value="127.0.0.1" placeholder="IP Address">
                <br>
                <input type="text" name="client_port" id="client_port" value="5001" placeholder="Port">
                <br>
                <button type="button" id="btn_client_start">Connect</button>
            </fieldset>
        </div>
        <div class="main">
            <fieldset>
                <legend>Response</legend>
                <input type="checkbox" name="is_hex1" id="is_hex1">
                <label for="is_hex1">Hex</label>
                <button type="button" id="btn_clean1">Clean</button>
                <textarea name="response" id="response" rows="8"></textarea>
            </fieldset>
            <fieldset>
                <legend>Send</legend>
                <input type="checkbox" name="is_hex2" id="is_hex2">
                <label for="is_hex2">Hex</label>
                <button type="button" id="btn_send">Send</button>
                <button type="button" id="btn_clean2">Clean</button>
                <textarea name="send" id="send" rows="8"></textarea>
            </fieldset>
        </div>
    </div>
    <script type="text/javascript">
        var util = require('util');
        var net = require('net');
        var server = null,
            socket = null;
        const LISTEN_TEXT = 'Listen';
        const CLOSE_TEXT = 'Close';
        util.log('Hello Electron TCP!');

        var $ = function (id) {
            return document.getElementById(id);
        }

        $('btn_server_start').addEventListener('click', function(ev){
            var btn_text = $('btn_server_start').innerHTML;
            if (btn_text == CLOSE_TEXT) {
                $('btn_server_start').innerHTML = LISTEN_TEXT;
                $('server_port').disabled = false;
                server_stop();
            } else {
                $('btn_server_start').innerHTML = CLOSE_TEXT;
                $('server_port').disabled = true;
                server_start();
            }
        });

        function server_start() {
            var server_port = $('server_port').value;
            server = net.createServer(function (socket) {
                socket = socket;
                util.log(socket.remoteAddress + ' is connecting!');
                socket.on('data', function (data) {
                    var dataHex = data.toString('hex');
                    var dataString = data.toString('utf8');
                    util.log('get data:' + dataString);
                    $('response').innerHTML = dataString;
                });
                $('btn_send').addEventListener('click', function (ev) {
                    var data = $('send').value;
                    socket.write(data);
                    util.log('send data:' + data);
                });
            }).listen(server_port);
            util.log('Socket server is running on ' + server_port);
        }

        function server_stop() {
            if (socket !== null) {
                socket.end();
                util.log('socket end');
            }
            if (server !== null) {
                server.close();
                util.log('server close');
            }
        }
    </script>
</body>

</html>
